<?php
/*$Id$*/
if(!defined('IN_DISCUZ')) { exit('Access Denied'); } class mini_Controller{ public function __construct(){ } public function checkpost( $id ){ if (!submitcheck($id)) { showmessage('undefined_action', NULL, 'HALTED'); exit; } } public function assign($name,$value=''){ if(is_array($name)){ foreach ($name as $k => $v){ if(isset($_REQUEST[$k]) || !isset($GLOBALS[$k])){ $GLOBALS[$k] = $v; } } }else{ if(isset($_REQUEST[$name]) || !isset($GLOBALS[$name])){ $GLOBALS[$name] = $value; } } } public function display($tplFileName){ define ('APP_TPL_FILENAME',$tplFileName); } } if(!defined('IN_DISCUZ')) { exit('Access Denied'); } class mini_Model{ public $db; protected $_tableName = ''; protected $_realtableName = ''; protected $_fields = array( 'id', '_pk' => 'id', '_autoinc' => true, ); protected $_defaultparams = array( 'field' => '*', 'table' => '', 'extra' => '', 'order' => '', 'limit_start' => 0, 'limit_offset' => 0, ); public $data = array(); public $lastsql = ''; public function __construct(){ $this->db = $GLOBALS['db']; $this->settableName(); } public function setProperty( $property, $value = '' ){ if( is_array($property) ){ foreach ( $property as $k => $v ){ $this->setProperty( $k, $v ); } }else{ if( $property == 'tableName' ){ $this->settableName( $value ); }else{ $property == '_'. $property; $this->$property = $value; } } return $this; } public function settableName( $name = '' ){ if( $name !== '' ){ $this->_tableName = $name; } if( $name !== '' || $this->_realtableName === '' ){ if( $this->_tableName === '' ){ $this->_tableName = str_replace( array('_Model', 'Model'), '', get_class($this) ); } $this->_realtableName = $GLOBALS['tablepre']. $this->_tableName; } return $this; } public function __set( $name, $value ){ throw new Exception('No such property can you set: '.$property ); } public function find( $value, $params = array() ){ if ( isset( $this->_fields['_pk'] ) && !empty( $this->_fields['_pk'] ) ) { $params['extra'] = ' WHERE '. $this->_fields['_pk']. "='". $value. "' " ; $params['limit_offset'] = 1; return $this->select($params); }else{ return false; } } public function select( $params = array(), $indexkey = null ){ $this->_parseParam( $params ); $sql = 'SELECT '. $params['field']. ' FROM '. $params['table']. ' ' .$params['extra']; $datalist = $this->query($sql, $indexkey); if( $params['limit_offset'] == 1 && !empty($datalist) ){ $this->data = end($datalist); return $this->data; } return $datalist; } public function insert( $data = array(), $params = array(), $type = 'INSERT' ){ if( empty($data) ){ if( !empty($this->data) ){ $data = $this->data; }else{ return false; } } $this->_parseParam( $params ); $type = ($type === 'REPLACE') ? $type : 'INSERT'; $this->_datafilterBYfield( $data , $params['field'], $type ); $sql = $sqlfields = $sqldata = ''; foreach ($data as $key => $value){ $sqlfields .= '`'. $key. '`,' ; $sqldata .= '\''. $value. '\',' ; } if( $sqlfields !== '' && $sqldata !== '' ){ $sqlfields = '('. substr($sqlfields, 0, -1). ')'; $sqldata = '('. substr($sqldata, 0, -1). ')'; $sql = $type. ' INTO '. $params['table']. ' '. $sqlfields. ' VALUES '. $sqldata; return $this->execute( $sql ); }else{ return 0; } } public function update( $data = array() , $params = array() ){ if( empty($data) ){ if( !empty($this->data) ){ $data = $this->data; }else{ return false; } } if( !isset($params['extra']) && isset( $this->_fields['_pk'] ) && !empty( $this->_fields['_pk'] ) && isset( $data[$this->_fields['_pk']] ) ){ $params['extra'] = ' WHERE '. (string)$this->_fields['_pk']. "='". (string)$data[$this->_fields['_pk']]. "' " ; } $this->_parseParam( $params ); $this->_datafilterBYfield( $data , $params['field'], 'UPDATE' ); foreach ($data as $key => $value){ if( preg_match('/[\+\-\*\/]+/', $value) > 0 ){ $data[$key] = $key. ' = '. $value; }else{ $data[$key] = $key. " = '". $value. "'"; } } if( !empty($data) ){ $sql = 'UPDATE '. $params['table']. ' SET '. implode(',', $data). ' '. $params['extra']; return $this->execute($sql); }else{ return 0; } } public function delete( $params = array() ){ if( empty($params) && isset( $this->_fields['_pk'] ) && !empty( $this->_fields['_pk'] ) && isset($data[$this->_fields['_pk']]) && !empty($data[$this->_fields['_pk']]) ){ $params['extra'] = ' WHERE '. $this->_fields['_pk']. "='". common::addslashes( $data[$this->_fields['_pk']], 1, true ). "'" ; }else{ return false; } $this->_parseParam( $params ); $sql = 'DELETE FROM '. $params['table']. ' ' .$params['extra']; return $this->execute( $sql ); } public function query( $sql, $indexkey = null ){ $sql = str_replace( '__TABLEPRE__', $GLOBALS['tablepre'], $sql ); $this->lastsql = $sql; $query = $this->db->query( $sql ); $result = array(); if( $indexkey === true && isset($this->params['_pk']) &&!empty($this->params['_pk']) ){ $indexkey = $this->params['_pk']; } while( $current = $this->db->fetch_array($query) ) { if ( $indexkey === null || !isset($current[$indexkey]) ) { $result[] = $current; }else{ $result[$current[$indexkey]] = $current; } } return $result; } public function execute( $sql, $type = '' ){ $sql = str_replace( '__TABLEPRE__', $GLOBALS['tablepre'], $sql ); $this->lastsql = $sql; $this->db->query($sql, $type ); $sqlpre = strtoupper( substr( trim($sql), 0, 3 ) ); switch ($sqlpre){ case 'INS': return $this->db->insert_id(); break; default: return intval( $this->db->affected_rows() ); break; } } protected function _parseParam( &$params ){ $params = array_merge( $this->_defaultparams, $params ); if( $params['table'] === '' ){ $params['table'] = $this->_realtableName; } if( $params['order'] !== '' ){ $params['extra'] = $params['extra']. ' ORDER BY '. $params['order']; } if( $params['limit_offset'] > 0 ){ $params['extra'] = $params['extra']. ' LIMIT '. $params['limit_start']. ','. $params['limit_offset']; } } protected function _datafilterBYfield( &$data , $fields = '*', $sqltype = 'REPLACE' ){ if( $fields !== '*' ){ $fields = preg_replace( '/\,[ ]+/', ',', $fields ); $fields = explode( ',', $fields ); }else{ $fields = $this->_fields; if( $sqltype !== 'REPLACE' && isset( $this->_fields['_pk'] ) && $this->_fields['_pk'] !== '' && $this->_fields['_autoinc'] === true ){ unset($data[$this->_fields['_pk']]); } unset( $fields['_pk'], $fields['_autoinc'] ); } $fields = array_flip( $fields ); foreach( $data as $key => $value ){ if( !array_key_exists( $key, $fields ) || !is_scalar($value) ){ unset($data[$key]); } } } } if(!defined('IN_DISCUZ')) { exit('Access Denied'); } class common{ protected static $_objectInstance = array(); public static $config = array(); public static function getInstanceOf( $classname , $index = null, $filepath = null ){ if( null === $index ){ $index = $classname; } if( isset( self::$_objectInstance[$index] ) ){ $instance = self::$_objectInstance[$index]; if( !($instance instanceof $classname) ){ throw new Exception( "Key {$index} has been tied to other thing." ); } }else{ if( null !== $filepath && !class_exists($classname) ){ if( !is_file( $filepath ) ){ @trigger_error('No such controller file can PHP find:'.$filepath, 512 ); exit( 'No such controller file can PHP find' ); } require( realpath($filepath) ); } $instance = new $classname(); self::$_objectInstance[$index] = $instance; } return $instance; } public static function input($k, $var='GET', $default = null, $emptyCheck = false ) { $var = '_'. $var; $result = $default; if( isset($GLOBALS[$var][$k]) && isset($GLOBALS[$k]) ){ $result = $GLOBALS[$k]; } if( true === $emptyCheck && empty($result) ){ $result = $default; } return $result; } public static function addslashes($string, $force = 0, $strip = FALSE) { if(!ini_get('magic_quotes_gpc') || $force) { if(is_array($string)) { $temp = array(); foreach($string as $key => $val) { $key = addslashes($strip ? stripslashes($key) : $key); $temp[$key] = self::addslashes($val, $force, $strip); } $string = $temp; unset($temp); } else { $string = addslashes($strip ? stripslashes($string) : $string); } } return $string; } public static function config( $type, $value ){ switch ($type){ case 'get': return isset(self::$config[$value]) ? self::$config[$value] : null; break; case 'set': self::$config = array_merge(self::$config, $value); return true; break; } } }